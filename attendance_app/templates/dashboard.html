{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4">Welcome, {{ current_user.name }} üëã</h2>

  {% if active_clock_in %}
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card border-start border-info border-4 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">‚è∞ Clocked In At</h5>
          <p class="fs-4 text-info">{{ active_clock_in.strftime('%H:%M:%S') }}</p>
          <p class="mb-0"><strong>Live Duration:</strong> <span id="liveDuration" class="text-dark">00:00:00</span></p>
        </div>
      </div>
    </div>

    {% if active_break_start %}
    <div class="col-md-6">
      <div class="card border-start border-warning border-4 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">‚òï On Break Since</h5>
          <p class="fs-4 text-warning">{{ active_break_start.strftime('%H:%M:%S') }}</p>
          <p class="mb-0"><strong>Break Duration:</strong> <span id="breakTimer" class="text-dark">00:00:00</span></p>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <div class="mt-5">
    <h4 class="mb-3">üìã Attendance Sessions ‚Äì {{ today.strftime('%Y-%m-%d') }}</h4>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-primary">
          <tr>
            <th>#</th>
            <th>Clock In</th>
            <th>Clock Out</th>
            <th>Regular Hours</th>
            <th>Overtime</th>
            <th>Late (min)</th>
          </tr>
        </thead>
        <tbody>
          {% set total_regular = namespace(value=0.0) %}
          {% set total_overtime = namespace(value=0.0) %}

          {% for session in sessions %}
            {% set dt_in = datetime.combine(today, session.clock_in) %}
            {% set dt_out = datetime.combine(today, session.clock_out) if session.clock_out else none %}
            {% set overtime = session.overtime or 0 %}

            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ session.clock_in.strftime('%H:%M:%S') }}</td>
              <td>
                {% if session.clock_out %}
                  {{ session.clock_out.strftime('%H:%M:%S') }}
                {% else %}
                  <span class="text-danger">‚Äî</span>
                {% endif %}
              </td>
              <td>
                {% if dt_out %}
                  {% set duration_hours = (dt_out - dt_in).total_seconds() / 3600 %}
                  {% set regular_hours = duration_hours - overtime %}
                  {{ "%.2f"|format(regular_hours) }}
                  {% set total_regular.value = total_regular.value + regular_hours %}
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
              <td>
                {{ "%.2f"|format(overtime) }}
                {% set total_overtime.value = total_overtime.value + overtime %}
              </td>
              <td>{{ session.late_minutes or 0 }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="mt-4">
    <div class="row text-center">
      <div class="col-md-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h6 class="text-muted">Regular Hours</h6>
            <h4 class="text-primary">{{ "%.2f"|format(total_regular.value) }} hrs</h4>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h6 class="text-muted">Overtime</h6>
            <h4 class="text-info">{{ "%.2f"|format(total_overtime.value) }} hrs</h4>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h6 class="text-muted">Total Hours</h6>
            <h4 class="text-success">{{ "%.2f"|format(total_regular.value + total_overtime.value) }} hrs</h4>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-5 d-flex justify-content-center gap-3">
    <a href="{{ url_for('clock_in') }}" class="btn btn-success btn-lg">üü¢ Clock In</a>
    <form method="post" action="{{ url_for('start_break') }}" style="display:inline;">
      <button type="submit" class="btn btn-warning btn-lg">‚è∏Ô∏è Start Break</button>
    </form>
    <form method="post" action="{{ url_for('end_break') }}" style="display:inline;">
  <button type="submit" class="btn btn-secondary btn-lg">‚ñ∂Ô∏è End Break</button>
</form>
    <a href="{{ url_for('clock_out') }}" class="btn btn-danger btn-lg">üî¥ Clock Out</a>
  </div>
</div>

{% if active_clock_in %}
<script>
  const clockIn = new Date("{{ today.isoformat() }}T{{ active_clock_in.strftime('%H:%M:%S') }}");
  const liveTimer = document.getElementById("liveDuration");

  function updateLiveDuration() {
    const now = new Date();
    const diff = now - clockIn;

    if (diff > 0) {
      const hrs = Math.floor(diff / (1000 * 60 * 60));
      const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const secs = Math.floor((diff % (1000 * 60)) / 1000);

      liveTimer.textContent = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
  }

  updateLiveDuration();
  setInterval(updateLiveDuration, 1000);
</script>
{% endif %}

{% if active_break %}
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card border-start border-warning border-4 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">‚òï On Break Since</h5>
        <p class="fs-4 text-warning">{{ active_break.start_time.strftime('%H:%M:%S') }}</p>
        <p><strong>Break Duration:</strong> <span id="breakDuration" class="text-dark">00:00:00</span></p>
      </div>
    </div>
  </div>
</div>

<script>
  const breakStart = new Date("{{ today.isoformat() }}T{{ active_break.start_time.strftime('%H:%M:%S') }}");
  const breakTimer = document.getElementById("breakDuration");

  function updateBreakDuration() {
    const now = new Date();
    const diff = now - breakStart;

    if (diff > 0) {
      const hrs = Math.floor(diff / (1000 * 60 * 60));
      const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const secs = Math.floor((diff % (1000 * 60)) / 1000);

      breakTimer.textContent =
        String(hrs).padStart(2, '0') + ':' +
        String(mins).padStart(2, '0') + ':' +
        String(secs).padStart(2, '0');
    }
  }

  updateBreakDuration();
  setInterval(updateBreakDuration, 1000);
</script>
{% endif %}
{% endblock %}
